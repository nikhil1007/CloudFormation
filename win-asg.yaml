AWSTemplateFormatVersion: 2010-09-09
Description: >-
  To make sure the instances launched from Autoscaling are protected from
  Scale-in
Parameters:
  ami:
    Type: String
    Description: >-
      Enter a valid ami id keeping in mind the region this CFN template is being
      launched.
  InstanceType:
    Type: String
    Description: >-
      Enter valid instance Type depending on your resource requirement. Default
      is t2.micro.
  keypair:
    Type: 'AWS::EC2::KeyPair::KeyName'
    Description: Choose a valid keypair
  SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup::Id'
    Description: Choose a security group to associate with launchconfiguration
  AutoScalingGroup:
    Type: String
    Description: Name of your AutoScaling Group
  IAMrole:
    Type: String
    Description: >-
      Enter a role to which an instance profile will be attached to give instances required perms to execute commands
Resources:
  InstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref IAMrole
  launchConfig:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      IamInstanceProfile: !Ref InstanceProfile
      ImageId: !Ref ami
      InstanceType: !Ref InstanceType
      KeyName: !Ref keypair
      SecurityGroups:
        - !Ref SecurityGroup
      UserData: !Base64
        Fn::Sub: >
          <powershell>
          iex ((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1'))
          choco install python -y
          (new-object net.webclient).DownloadFile('https://s3.amazonaws.com/aws-cli/AWSCLI64.msi','c:\AWSCLI64.msi')
          msiexec.exe /i 'C:\AWSCLI64.msi' /qn
          $instanceId = (New-Object System.Net.WebClient).DownloadString("http://169.254.169.254/latest/meta-data/instance-id‚Äù)
          aws autoscaling set-instance-protection --instance-ids $instanceID --auto-scaling-group-name ${AutoScalingGroup} --region ${AWS::Region}
          </powershell>
  AutoScalingGrp:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AutoScalingGroupName: !Ref AutoScalingGroup
      AvailabilityZones: !GetAZs
        Ref: 'AWS::Region'
      LaunchConfigurationName: !Ref launchConfig
      MaxSize: '3'
      MinSize: '1'
